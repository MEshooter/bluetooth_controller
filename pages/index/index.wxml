<!-- index.wxml -->
<view class="container">

<!-- 1. Connection Overlay (Scanning & Pairing) -->
<view class="connect-overlay" wx:if="{{!isConnected}}">
  <!-- Language toggle: Displays target language label -->
  <view class="lang-switch" bindtap="toggleLang">
    {{curLang === 'zh' ? 'EN' : '中'}}
  </view>

  <view class="overlay-content">
    <view class="scan-left">
      <view class="overlay-title">{{t.title}}</view>
      <button type="primary" class="main-btn" loading="{{isScanning}}" bindtap="startScan">
        {{isScanning ? t.scanning : t.scan}}
      </button>
      <button class="debug-btn" bindtap="enterDebugMode">{{t.debug}}</button>
    </view>

    <view class="scan-right">
      <view class="list-header">{{t.list_title}} ({{devices.length}})</view>
      <scroll-view scroll-y class="device-scroll">
        <block wx:if="{{devices.length > 0}}">
          <view wx:for="{{devices}}" wx:key="deviceId" class="device-item" bindtap="connectDevice" data-id="{{item.deviceId}}" data-name="{{item.name}}">
            <view class="dev-row">
              <text class="dev-name">{{item.name || 'Unknown Device'}}</text>
              <text class="dev-rssi">{{item.RSSI}}</text>
            </view>
            <view class="dev-id">ID: {{item.deviceId}}</view>
          </view>
        </block>
        <view wx:else class="empty-tip">{{t.empty}}</view>
      </scroll-view>
    </view>
  </view>
</view>

<!-- 2. Main Remote Controller UI -->
<block wx:else>
  <!-- Mini Console for System Logs -->
  <scroll-view class="mini-console" scroll-y scroll-top="{{scrollTop}}">
    <view wx:for="{{logList}}" wx:key="index" class="log-item log-{{item.type}}">
      [{{item.time}}] {{item.msg}}
    </view>
  </scroll-view>

  <!-- Device Status Badge -->
  <view class="status-badge">
    <view class="status-dot" style="background: {{connectedDeviceId === 'DEBUG' ? '#ff9800' : '#4caf50'}}"></view>
    <text>{{connectedName}}</text>
  </view>

  <!-- Raw Command Input -->
  <view class="cmd-badge">
    <input class="mini-input" placeholder="CMD" confirm-type="send" bindconfirm="sendInputCmd" value="{{inputText}}" bindinput="handleInput" />
    <view class="mini-send" bindtap="sendInputCmd">></view>
  </view>

  <!-- Left Control Pad: Directional Buttons or Joystick -->
  <view class="left-pad">
    <block wx:if="{{!isJoystickMode}}">
      <view class="d-btn btn-up"    hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="U">U</view>
      <view class="d-btn btn-left"  hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="L">L</view>
      <view class="d-btn btn-right" hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="R">R</view>
      <view class="d-btn btn-down"  hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="D">D</view>
    </block>
    <view wx:else class="joystick-base" id="joystick-bg" catchtouchstart="stickStart" catchtouchmove="stickMove" catchtouchend="stickEnd">
      <view class="joystick-knob" style="transform: translate({{stickX}}px, {{stickY}}px);"></view>
    </view>
  </view>

  <!-- Center Panel: Speed and System Toggle -->
  <view class="center-pad">
    <view class="speed-container">
      <text class="speed-label">{{t.speed}}: {{speed}}</text>
      <slider class="speed-slider" min="1" max="10" step="1" value="{{speed}}" block-size="24" activeColor="#2196F3" backgroundColor="#ddd" bindchange="handleSpeedChange" />
    </view>
    <view class="center-btns">
      <view class="switch-btn" bindtap="toggleMode">{{isJoystickMode ? t.mode_js : t.mode_btn}}</view>
      <view class="row-btns">
        <view class="small-btn cam-btn" hover-class="btn-hover" bindtap="openCamera">CAM</view>
        <view class="small-btn" hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="S">STOP</view>
        <view class="small-btn exit-btn" hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtap="disconnect">EXIT</view>
      </view>
    </view>
  </view>

  <!-- Right Control Pad: Action Buttons -->
  <view class="right-pad">
    <view class="c-btn btn-top"    hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="A">A</view>
    <view class="c-btn btn-left2"  hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="B">B</view>
    <view class="c-btn btn-right2" hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="E">E</view>
    <view class="c-btn btn-bottom" hover-class="btn-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="handleBtnPress" bindtouchend="handleBtnRelease" data-char="F">F</view>
  </view>

  <!-- Camera PTZ Controls (Pitch/Yaw) -->
  <view class="cam-ctrl-group ptz-left">
    <view class="cam-round-btn" hover-class="cam-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="startCamMove" bindtouchend="stopCamMove" data-dir="D">▼</view>
    <view class="cam-info"><text class="cam-val">PITCH {{camAngleUD}}°</text></view>
    <view class="cam-round-btn" hover-class="cam-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="startCamMove" bindtouchend="stopCamMove" data-dir="U">▲</view>
  </view>

  <view class="cam-ctrl-group ptz-right">
    <view class="cam-round-btn" hover-class="cam-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="startCamMove" bindtouchend="stopCamMove" data-dir="L">◀</view>
    <view class="cam-info"><text class="cam-val">YAW {{camAngleLR}}°</text></view>
    <view class="cam-round-btn" hover-class="cam-hover" hover-start-time="0" hover-stay-time="0" bindtouchstart="startCamMove" bindtouchend="stopCamMove" data-dir="R">▶</view>
  </view>

  <!-- Floating Video Player Window -->
  <movable-area class="drag-area" wx:if="{{isVideoMode}}">
    <movable-view 
      class="drag-view" 
      direction="all" 
      x="{{videoX}}" 
      y="{{videoY}}" 
      out-of-bounds="false" 
      damping="30"
    >
      <canvas type="2d" id="videoCanvas" class="mjpeg-player"></canvas>
      <view class="ui-close-btn" catchtap="closeCamera">
        <view class="ui-close-text">×</view>
      </view>

      <!-- Video Overlay Tools (Photo, Record, AI, Tracking) -->
      <view class="cam-tools">
        <view class="tool-btn" catchtap="takePhoto" hover-class="tool-hover" hover-start-time="0" hover-stay-time="0">
          <view class="css-icon icon-dot-white"></view>
        </view>
        <view class="tool-btn" catchtap="toggleRecord" hover-class="tool-hover" hover-start-time="0" hover-stay-time="0">
          <view class="css-icon {{isRecording ? 'icon-square-red' : 'icon-dot-red'}}"></view>
        </view>
        <view class="tool-btn text-btn {{isAI ? 'btn-active' : ''}}" 
              catchtap="toggleAI" hover-class="tool-hover" hover-start-time="0" hover-stay-time="0">
          AI
        </view>
        <view class="tool-btn text-btn {{isTRK ? 'btn-active' : ''}}" 
              catchtap="toggleTRK" hover-class="tool-hover" hover-start-time="0" hover-stay-time="0">
          TRK
        </view>
      </view>

      <!-- Status Overlays -->
      <view class="ui-loading" wx:if="{{videoLoading}}"><text>{{t.connect}}</text></view>
      <view class="ui-drag-bar"></view>
    </movable-view>
  </movable-area>
</block>
</view>